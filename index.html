<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lithium Battery Recycling Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div class="row align-items-center">
                <div class="col-md-6"> <!-- Adjusted column size -->
                    <h1>Lithium Battery Recycling in North America</h1>
                    <p class="text-muted">Interactive Map of Recycling Facilities</p>
                </div>
                <div class="col-md-6"> <!-- Adjusted column size -->
                     <!-- Navigation Menu -->
                    <nav class="navbar navbar-expand-lg navbar-light bg-light rounded p-2 float-end">
                        <div class="container-fluid">
                            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                                <span class="navbar-toggler-icon"></span>
                            </button>
                            <div class="collapse navbar-collapse" id="navbarNav">
                                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                                    <li class="nav-item">
                                        <a class="nav-link active" aria-current="page" href="index.html">Map</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="facilities.html">Facilities</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="charts.html">Charts</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="documents.html">Documents</a> <!-- Added Documents Link -->
                                    </li>
                                </ul>
                                <!-- Theme Toggle Switch -->
                                <div class="form-check form-switch me-3">
                                    <input class="form-check-input" type="checkbox" role="switch" id="themeSwitch">
                                    <label class="form-check-label" for="themeSwitch"><i class="fas fa-moon"></i></label>
                                </div>
                                <!-- End Theme Toggle Switch -->
                                <div id="authStatus" class="d-flex align-items-center"> <!-- Removed ms-3 from here -->
                                    <!-- Login/Logout status will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </nav>
                </div>
            </div>
        </div>
        
        <!-- Stats Cards Row REMOVED -->
        
        <div class="row">
            <div class="col-12"> <!-- Changed from col-md-8 -->
                <div class="map-container" id="map-container">
                    <div id="map"></div>
                    
                        <h6 class="mb-2">Facility Status</h6>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #4CAF50;"></div>
                            <span>Operating</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #FFC107;"></div>
                            <span>Under Construction</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #2196F3;"></div>
                            <span>Planned</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #9C27B0;"></div>
                            <span>Pilot</span>
                        </div>
                        </div>
                    </div>
                    <hr style="margin: 8px 0;"> <!-- Separator -->
                    <div class="form-check form-switch form-check-sm">
                        <input class="form-check-input" type="checkbox" role="switch" id="sizeByCapacityToggle">
                        <label class="form-check-label" for="sizeByCapacityToggle" style="font-size: 0.9em;">Size by Capacity</label>
                    </div>
                </div>
            </div>
        </div> <!-- End of first row (Map only) -->

        <!-- Facilities List Row REMOVED -->

        <!-- Charts Row REMOVED -->

    </div> <!-- End dashboard-container -->
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Dashboard JS -->
    <script src="js/dashboard.js"></script>

    <script>
        // --- Authentication Check ---
        async function checkAuthStatus() {
            const authStatusElement = document.getElementById('authStatus');
            if (!authStatusElement) return;

            try {
                const response = await fetch('/api/session');
                const sessionData = await response.json();

                if (sessionData.loggedIn) {
                    authStatusElement.innerHTML = `
                        <span>Welcome, ${sessionData.user.username}!</span>
                        <a href="new-facility.html" class="btn btn-sm btn-success ms-2"><i class="fas fa-plus"></i> Add Facility</a>
                        <a href="#" id="logoutLink" class="btn btn-sm btn-outline-danger ms-2">Logout</a>
                    `;
                    // Add event listener for logout
                    document.getElementById('logoutLink').addEventListener('click', handleLogout);
                } else {
                    authStatusElement.innerHTML = `
                        <a href="login.html" class="btn btn-sm btn-outline-success">Admin Login</a>
                    `;
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
                authStatusElement.innerHTML = '<span class="text-danger">Session check failed</span>';
            }
        }

        async function handleLogout(event) {
            event.preventDefault();
            try {
                const response = await fetch('/api/logout');
                const result = await response.json();
                if (result.success) {
                    // Reload the page or update UI to reflect logout
                    window.location.reload();
                } else {
                    alert('Logout failed. Please try again.');
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('An error occurred during logout.');
            }
        }

        // Check auth status when the page loads
        document.addEventListener('DOMContentLoaded', checkAuthStatus);

        // --- Theme Switcher Logic ---
        const themeSwitch = document.getElementById('themeSwitch');
        const themeIcon = document.querySelector('label[for="themeSwitch"] i'); // Get the icon
        const currentTheme = localStorage.getItem('theme') ? localStorage.getItem('theme') : null;

        // Apply saved theme on initial load
        if (currentTheme) {
            document.body.classList.add(currentTheme); // Add 'dark-theme' if saved
            if (currentTheme === 'dark-theme') {
                themeSwitch.checked = true;
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                 themeIcon.classList.remove('fa-sun');
                 themeIcon.classList.add('fa-moon');
            }
        } else {
            // Default icon if no theme saved
             themeIcon.classList.add('fa-moon');
        }


        // Listener for theme switch toggle
        themeSwitch.addEventListener('change', function(e) {
            if (e.target.checked) {
                document.body.classList.add('dark-theme');
                localStorage.setItem('theme', 'dark-theme');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                document.body.classList.remove('dark-theme');
                localStorage.setItem('theme', 'light-theme'); // Explicitly save light theme
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        });
        // --- End Theme Switcher Logic ---

    </script>
</body>
</html>
